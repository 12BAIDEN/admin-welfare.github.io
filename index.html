<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADMIN WELFARE</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="page">
    <div class="card">
      <header>
        <h1>ADMIN WELFARE</h1>
        <div class="controls">
          <button class="btn" id="addRow">Add Row</button>
          <button class="btn" id="clear">Clear Values</button>
          <button class="btn primary" onclick="window.print()">Print</button>
        </div>
      </header>

      <section class="meta">
        
        <div class="field">
          <label class="label" for="welfareName">Name</label>
          <input class="input" id="welfareName" placeholder="Department/Group name" />
        </div>
        <div class="field">
          <label class="label" for="currency">Currency</label>
          <input class="input" id="currency" value="GHS" />
        </div>
        <div class="field">
          <label class="label" for="months">Months (columns)</label>
          <input class="input" id="months" value="Jan-25, Feb-25, Mar-25" />
        </div>
      </section>

      <div class="table-wrap">
        <table id="welfareTable" aria-describedby="welfare table">
          <thead>
            <tr id="headRow">
              <th class="serial">Serial</th>
              <th class="reg">Reg. Num</th>
              <th>Name</th>
              <th class="narrow">Monthly Dues (<span id="curLabel">GHS</span>)</th>
              <!-- Month headers injected here -->
              <th class="narrow">Total</th>
            </tr>
          </thead>
          <tbody id="bodyRows">
            <!-- Initial rows -->
          </tbody>
          <tfoot>
            <tr id="totalsRow">
              <td colspan="1"><strong>Total</strong></td>
              <td></td>
              <td></td>
              <td class="num" id="duesTotal">0</td>
              <!-- Month totals injected here -->
              <td class="num" id="grandTotal">0</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="footer">
        <span>Â© <span id="year"></span> Admin Welfare</span>
      </div>
    </div>
  </div>

  <script>
    const currencyInput = document.getElementById('currency');
    const curLabel = document.getElementById('curLabel');
    const monthsInput = document.getElementById('months');
    const headRow = document.getElementById('headRow');
    const bodyRows = document.getElementById('bodyRows');
    const totalsRow = document.getElementById('totalsRow');
    const duesTotalCell = document.getElementById('duesTotal');
    const grandTotalCell = document.getElementById('grandTotal');
    const yearSpan = document.getElementById('year');
    yearSpan.textContent = new Date().getFullYear();

    const state = { months: [] };

    function parseMonths() {
      const raw = monthsInput.value.trim();
      return raw ? raw.split(',').map(m => m.trim()).filter(Boolean) : [];
    }

    function rebuildHeaders() {
      // Remove existing dynamic month headers (everything between dues and total)
      // First, clear them from the head
      while (headRow.children.length > 5) {
        headRow.removeChild(headRow.children[4]);
      }
      // Then, clear from tfoot
      while (totalsRow.children.length > 5) {
        totalsRow.removeChild(totalsRow.children[4]);
      }
      // Add new headers
      state.months.forEach(() => {
        const th = document.createElement('th');
        th.className = 'narrow';
        th.textContent = '';
        headRow.insertBefore(th, headRow.lastElementChild);
        const td = document.createElement('td');
        td.className = 'num';
        td.textContent = '0';
        totalsRow.insertBefore(td, totalsRow.lastElementChild);
      });
      // Set header labels text after ensuring order
      const hdrs = [...headRow.children];
      let idx = 0;
      hdrs.forEach((el, i) => {
        if (i >= 4 && i < hdrs.length - 1) {
          el.textContent = state.months[idx++] || '';
        }
      });
    }

    function addRow() {
      const tr = document.createElement('tr');
      const serial = document.createElement('td');
      const reg = document.createElement('td');
      const name = document.createElement('td');
      const dues = document.createElement('td');

      serial.textContent = bodyRows.children.length + 1;
      reg.innerHTML = '<input class="cell-input" placeholder="Reg #" />';
      name.innerHTML = '<input class="cell-input" placeholder="Member name" />';
      dues.innerHTML = '<input inputmode="decimal" type="number" step="0.01" class="cell-input num" value="" placeholder="0.00" />';

      tr.append(serial, reg, name, dues);

      state.months.forEach(() => {
        const td = document.createElement('td');
        td.innerHTML = '<input inputmode="decimal" type="number" step="0.01" class="cell-input num" value="" placeholder="0.00" />';
        tr.appendChild(td);
      });

      const total = document.createElement('td');
      total.className = 'num';
      total.textContent = '0';
      tr.appendChild(total);

      bodyRows.appendChild(tr);
      tr.addEventListener('input', recalc);
    }

    function ensureRows(min = 6) {
      while (bodyRows.children.length < min) addRow();
    }

    function recalc() {
      let duesTotal = 0;
      const monthTotals = new Array(state.months.length).fill(0);
      let grandTotal = 0;

      [...bodyRows.children].forEach((tr, rIdx) => {
        // Update serials
        tr.children[0].textContent = rIdx + 1;
        // Read dues
        const duesVal = numVal(tr.children[3].querySelector('input')?.value);
        duesTotal += duesVal;

        let rowSum = 0;
        // Month values start at index 4, count state.months
        state.months.forEach((_, i) => {
          const input = tr.children[4 + i].querySelector('input');
          const v = numVal(input?.value);
          monthTotals[i] += v;
          rowSum += v;
        });
        tr.lastElementChild.textContent = format(rowSum);
        grandTotal += rowSum;
      });

      duesTotalCell.textContent = format(duesTotal);

      // Put month totals into tfoot (starting at index 4)
      state.months.forEach((_, i) => {
        totalsRow.children[4 + i].textContent = format(monthTotals[i]);
      });
      grandTotalCell.textContent = format(grandTotal);
    }

    function numVal(v) { return Number.parseFloat(v || '0') || 0; }
    function format(n) { return new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n); }

    function rebuild() {
      state.months = parseMonths();
      rebuildHeaders();
      // Rebuild body rows to match month count
      [...bodyRows.children].forEach(tr => tr.remove());
      ensureRows(10);
      recalc();
    }

    // Events
    document.getElementById('addRow').addEventListener('click', () => { addRow(); });
    document.getElementById('clear').addEventListener('click', () => {
      [...document.querySelectorAll('input')].forEach(i => {
        if (['month','welfareName','currency','months'].includes(i.id)) return;
        i.value = '';
      });
      recalc();
    });
    monthsInput.addEventListener('change', rebuild);
    currencyInput.addEventListener('input', () => curLabel.textContent = currencyInput.value || '');

    // Init
    rebuild();
  </script>
</body>
</html>
